
Select  OsmpProviderID,ProviderID,ProviderName,ServiceID,
ServiceName ,case when summa is null then '0' else summa end as summa,
case when say is null then '0' else say end as say,case when cast([last paydate] as varchar) is null 
then '-' else cast([last paydate] as varchar) end as last_paydate from (
SELECT os.OsmpProviderID,pr.ProviderID,pr.ProviderName,s.ServiceID,
s.ServiceName,sum(summa)as summa,sum(say) as say,max(PayDate) as 'last paydate' 
FROM [gate211].[dbo].[Service] s left join
(Select ServiceID,sum(paysum) summa,PayDate,
count([AgentPaymentID]) say from [dbo].[Payment]
where PayDate between '2022-04-01' and '2022-05-01'
group by ServiceID,PayDate,OsmpProviderID) p 
on s.ServiceID=p.ServiceID left join Provider pr on s.ProviderID=pr.ProviderID
left join [dbo].[Osmp_Service] os
on s.ServiceID=os.ServiceID
group by os.OsmpProviderID,pr.ProviderID,pr.ProviderName,s.ServiceID,
s.ServiceName
)t order by summa desc
